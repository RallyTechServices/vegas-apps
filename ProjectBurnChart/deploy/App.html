<!DOCTYPE html>
<html>
<head>
    <title>ProjectBurnChart</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.override(Rally.ui.chart.Chart,{onRender:function(){this.callParent(arguments),this._unmask()}}),Ext.override(Rally.ui.combobox.ReleaseComboBox,{_toggleUnscheduledEntry:function(selected){var unscheduled=this.store.findRecord(this.displayField,this.noEntryText);unscheduled&&unscheduled.set("isSelected",selected)},_decorateRecords:function(){var store=this.store,selected;store&&(selected=this.getDefaultValue(),store.each(function(record){record.get("formattedName")===this.noEntryText?record.set("Name",this.noEntryText):record.set("formattedName",this._truncateName(record.get("Name"))),record.set("formattedStartDate",Rally.util.DateTime.formatWithDefault(record.get(this.startDateField))),record.set("formattedEndDate",Rally.util.DateTime.formatWithDefault(record.get(this.endDateField))),record.set("isSelected",record.get(this.valueField)===(selected&&selected._ref?selected._ref:selected))},this))}});
                Ext.define("ActualCalculator",{extend:"Rally.data.lookback.calculator.BaseCalculator",runCalculation:function(snapshots){for(var completedIterationTotals={},completedStoryIterations={},incompleteIterationTotals={},oldTotal,iteration,iterationName,s=0,l=snapshots.length;l>s;s++){var snapshot=snapshots[s],objectID=snapshot.ObjectID,iterations=this.getMatchingIterations(snapshot);if(0!==iterations.length)if("Accepted"===snapshot.ScheduleState)iteration=iterations[0],iterationName=iteration.get("Name"),snapshot._PreviousValues&&snapshot._PreviousValues.ScheduleState!==void 0&&!completedStoryIterations[objectID]&&(completedStoryIterations[objectID]=iteration,oldTotal=completedIterationTotals[iterationName]||0,completedIterationTotals[iterationName]=oldTotal+snapshot.PlanEstimate);else for(var iter=0,iterL=iterations.length;iterL>iter;iter++)iteration=iterations[iter],iterationName=iteration.get("Name"),oldTotal=incompleteIterationTotals[iterationName]||0,incompleteIterationTotals[iterationName]=oldTotal+snapshot.PlanEstimate}var actualSeriesData=[],cumulativeActuals=0,cumulativeActualSeriesData=[],backlogRemainingSeriesData=[],devIncreaseSeriesData=[],devIncrease,cumulativedevIncrease=0,previousBacklogRemaining=null,categories=[],TotalPoints=0,ReleaseIteration=0,pastIteration=!0,today=(new Date).getTime();ReleaseIteration=this.iterations.length-1||0;for(var i=0,il=this.iterations.length;il>i;i++){iteration=this.iterations[i];var iterationEnd=iteration.get("EndDate").getTime();pastIteration=today>=iterationEnd,iterationName=iteration.get("Name");var completedIterationTotal=completedIterationTotals[iterationName]||0;actualSeriesData.push(completedIterationTotal),pastIteration&&cumulativeActualSeriesData.push(cumulativeActuals),cumulativeActuals+=completedIterationTotal;var backlogRemaining=incompleteIterationTotals[iterationName]||0;0===i?(TotalPoints=backlogRemaining,devIncreaseSeriesData.push(0)):(devIncrease=Math.max(backlogRemaining-previousBacklogRemaining+completedIterationTotal,0),cumulativedevIncrease+=devIncrease,devIncreaseSeriesData.push(devIncrease),TotalPoints+=devIncrease),previousBacklogRemaining=backlogRemaining,pastIteration&&backlogRemainingSeriesData.push(backlogRemaining-Math.max(backlogRemaining-previousBacklogRemaining+completedIterationTotal,0));var endLabel=Rally.util.DateTime.formatWithDefault(iteration.get("EndDate")),str=iteration.get("Name"),iterationLabel=str.replace("Iteration","")+"-"+endLabel;categories.push(iterationLabel)}var backlogBurnProjectionSeriesData=this.calculateBacklogBurnProjection(backlogRemainingSeriesData,actualSeriesData,categories);return{series:[{name:"Work Done (Current iteration Accepted Points)",data:actualSeriesData},{name:"Total Work (Cumulative Accepted Points)",data:cumulativeActualSeriesData},{name:"Work Increase (Points per iteration)",data:devIncreaseSeriesData,stack:"1"},{name:"Backlog Remaining (Total Unaccepted Points)",data:backlogRemainingSeriesData,stack:"1"},{name:"Burn down projection",data:backlogBurnProjectionSeriesData},{name:"Ideal Line",data:[[0,TotalPoints],[ReleaseIteration,0]],type:"line"}],categories:categories}},calculateCapacityBurn:function(){for(var iterationRef,iterationCapacities={},c=0,l=this.capacities.length;l>c;c++){var capacity=this.capacities[c];iterationRef=capacity.get("Iteration")._ref;var oldTotal=iterationCapacities[iterationRef]||0;iterationCapacities[iterationRef]=oldTotal+capacity.get("Capacity")}for(var data=[0],remainingCapacity=0,i=this.iterations.length-1;i>0;i--){var iteration=this.iterations[i];iterationRef=iteration.get("_ref");var iterationCapacity=iterationCapacities[iterationRef]||0;remainingCapacity+=iterationCapacity,data.unshift(remainingCapacity)}return data},calculateBacklogBurnProjection:function(backlogRemainingSeriesData,actualSeriesData,categories){for(var twoWeeksInMillis=12096e5,backlogRemaining=null,data=[],last3AverageActuals,lastIterationModel=this.iterations[this.iterations.length-1],lastIteration={endDate:lastIterationModel.get("EndDate")},today=(new Date).getTime(),lastRealIterationIndex=null,i=0,l=this.iterations.length;l>i;i++){var iteration=this.iterations[i],iterationBeforeToday=today>=iteration.get("EndDate").getTime();if(!iterationBeforeToday||i===l-1){last3AverageActuals=0;for(var actualCount=0,j=lastRealIterationIndex-4;lastRealIterationIndex>=j;j++)0>j||(last3AverageActuals+=actualSeriesData[j],actualCount++);last3AverageActuals/=actualCount}iterationBeforeToday?(backlogRemaining=backlogRemainingSeriesData[i],lastRealIterationIndex=i):backlogRemaining-=last3AverageActuals,0>=backlogRemaining||iterationBeforeToday?data.push(null):data.push(backlogRemaining)}for(;backlogRemaining>0&&last3AverageActuals>0;){lastIteration={endDate:new Date(lastIteration.endDate.getTime()+twoWeeksInMillis)};var iterationLabel=Rally.util.DateTime.formatWithDefault(lastIteration.endDate);categories.push(iterationLabel),backlogRemaining-=last3AverageActuals,backlogRemaining=Math.max(0,backlogRemaining),data.push(backlogRemaining)}return data},getMatchingIterations:function(snapshot){for(var matches=[],i=0,l=this.iterations.length;l>i;i++){var iteration=this.iterations[i],iterationEnd=Rally.util.DateTime.toIsoString(iteration.get("EndDate"),!0),iterationStart=iteration.get("StartDate").getTime(),today=(new Date).getTime();iterationEnd>=snapshot._ValidFrom&&snapshot._ValidTo>iterationEnd&&today>=iterationStart&&matches.push(iteration)}return matches}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"selector_box",margin:10},{xtype:"container",itemId:"chart_box",margin:10}],launch:function(){console.log("Launching");var projectRef=this.getContext().getProjectRef(),projectOid=this.getContext().getProject().ObjectID;this.down("#selector_box").add({xtype:"rallyreleasecombobox",allowNoEntry:!0,padding:5,fieldLabel:"Release:",labelWidth:50,noEntryText:"-- All --",listeners:{scope:this,change:function(release_box,new_value,old_value,eOpts){console.log("Change Release",new_value),console.log(" Release: ",release_box.getRecord()),this.down("#chart_box").removeAll(),this.gatherData(projectRef,projectOid,release_box.getRecord())}}})},gatherData:function(projectRef,projectOid,release){this.loadIterations(projectRef,projectOid,release).then({scope:this,success:function(iterations){console.log("back from iterations",iterations);var iterationFilters=this.getIterationFilters(iterations);this.loadCapacities(projectRef,projectOid,iterationFilters).then({scope:this,success:function(capacities){console.log("back from capacities",capacities),this.setLoading(!1),this.loadChart(iterations,capacities,projectOid,release)},failure:function(error){console.log("Failed to load iteration capacities"),console.log(error)}})},failure:function(error){console.log("Failed to load iterations for project '"+projectRef+"'"),console.log(error)}})},getIterationFilters:function(iterations){console.log("getIterationFilters",iterations);for(var iterationFilters=[],i=0,l=iterations.length;l>i;i++)iterationFilters.push({property:"Iteration",value:iterations[i].get("_ref")});return iterationFilters},loadIterations:function(projectRef,projectOid,release){var deferred=Ext.create("Deft.Deferred");console.log("loadIterations",projectRef,projectOid,release);var filters=[{property:"Project",value:projectRef}],release_oid=release.get("ObjectID");if(release_oid>0){var start_date=Rally.util.DateTime.toIsoString(release.get("ReleaseStartDate")),end_date=Rally.util.DateTime.toIsoString(release.get("ReleaseDate"));filters.push({property:"EndDate",operator:"<=",value:end_date}),filters.push({property:"StartDate",operator:">=",value:start_date})}return Ext.create("Rally.data.wsapi.Store",{model:"Iteration",autoLoad:!0,context:{project:projectRef,projectScopeUp:!1,projectScopeDown:!1},filters:filters,sorters:[{property:"EndDate",direction:"ASC"}],listeners:{load:function(store,records,successful){console.log("returned with ",records,successful),successful?deferred.resolve(records):deferred.reject("Cannot load iterations")}}}),deferred},loadCapacities:function(projectRef,projectOid,iterationFilters){var deferred=Ext.create("Deft.Deferred");return console.log("loadCapacities",projectRef,projectOid),Ext.create("Rally.data.wsapi.Store",{model:"useriterationcapacity",autoLoad:!0,context:{project:projectRef,projectScopeUp:!1,projectScopeDown:!1},filters:Rally.data.QueryFilter.or(iterationFilters),fetch:["Capacity","Iteration"],listeners:{load:function(store,records,successful){successful?deferred.resolve(records):deffered.reject("Cannot load capacities")}}}),deferred},loadChart:function(iterations,capacities,projectOid,release){console.log("loadChart",iterations,capacities,projectOid,release);var filters={_ProjectHierarchy:projectOid,_TypeHierarchy:"HierarchicalRequirement",Children:null};release.get("ObjectID")>0&&(filters.Release=release.get("ObjectID"));var chart={xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:{find:filters,fetch:["PlanEstimate","ObjectID","ScheduleState","_ValidFrom","_ValidTo","_PreviousValues"],hydrate:["ScheduleState"],sort:{_ValidFrom:-1}},calculatorType:"ActualCalculator",calculatorConfig:{iterations:iterations,capacities:capacities,release:release},chartColors:["#006b2f","#009944","#A40000","#254361","#8E8E8E","#ee00000"],chartConfig:{chart:{type:"column",zoomType:"xy"},title:{text:"Project Burn Chart by Iteration"},xAxis:{labels:{rotation:-75,align:"right",style:{fontSize:"13px",fontFamily:"Verdana, sans-serif"}}},yAxis:{lineWidth:1,tickInterval:50,min:0,title:{text:"Story Points"}},plotOptions:{column:{stacking:"normal",borderWidth:0,shadow:!0},line:{connectNulls:!1,lineWidth:1,marker:{radius:2.5}}},tooltip:{shared:!0}}};this.down("#chart_box").removeAll(),this.down("#chart_box").add(chart)}});

            Rally.launchApp('CustomApp', {
                name:"ProjectBurnChart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
